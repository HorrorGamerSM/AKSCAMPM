<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Фотомониторинг CRM</title>
  <script src="https://cdn.tailwindcss.com "></script>
  <style>
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.4; }
      100% { opacity: 1; }
    }
    .notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 16px 24px;
      border-radius: 8px;
      max-width: 300px;
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.3s ease;
      z-index: 1000;
    }
    .notification.show {
      opacity: 1;
      transform: translateY(0);
    }
    .loader {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #fff;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 999;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: white;
      padding: 24px;
      border-radius: 8px;
      max-width: 400px;
      width: 90%;
      margin: 20px auto;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <!-- Уведомления -->
  <div id="notification" class="notification bg-green-500 text-white"></div>
  
  <!-- Модальное окно выбора сервиса -->
  <div id="serviceModal" class="modal">
    <div class="modal-content">
      <h3 class="text-lg font-bold mb-4">Выберите сервис</h3>
      <select id="serviceSelect" class="w-full px-3 py-2 border rounded mb-4">
        <option value="">-- Выберите сервис --</option>
        <option value="Сервис 1">Сервис 1</option>
        <option value="Сервис 2">Сервис 2</option>
        <option value="Сервис 3">Сервис 3</option>
      </select>
      <div class="flex justify-end">
        <button onclick="confirmService()" 
                class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:opacity-50" 
                id="confirmServiceBtn" disabled>
          Подтвердить
        </button>
      </div>
    </div>
  </div>
  
  <!-- Модальное окно подтверждения -->
  <div id="confirmationModal" class="modal hidden">
    <div class="modal-content">
      <h3 class="text-lg font-bold mb-4">Подтверждение отправки</h3>
      <p class="mb-4">Вы действительно хотите отправить это фото в Telegram?</p>
      <div class="flex justify-end space-x-2">
        <button onclick="hideConfirmation(false)" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">
          Отмена
        </button>
        <button onclick="hideConfirmation(true)" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
          Подтвердить
        </button>
      </div>
    </div>
  </div>
  
  <!-- Основной контент -->
  <div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold mb-8 text-gray-800">Фотомониторинг</h1>
    
    <!-- Блок текущего задания -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
      <div class="flex flex-col md:flex-row md:items-center justify-between">
        <div>
          <h2 class="text-xl font-semibold text-gray-700">Ежедневный фото-тест</h2>
          <p class="text-gray-600 mt-2">Пример: <span id="testExample" class="font-medium"></span></p>
          <p class="text-sm text-gray-500 mt-1">Срок выполнения: до 21:00</p>
          <p class="text-sm text-gray-500 mt-1">Сервис: <span id="testService" class="font-medium"></span></p>
        </div>
        <div class="mt-4 md:mt-0">
          <div id="statusBadge" class="inline-flex items-center px-3 py-1 rounded-full text-white font-medium"></div>
        </div>
      </div>
      
      <!-- Форма загрузки фото -->
      <div class="mt-6">
        <label class="block text-gray-700 mb-2">Загрузите фото:</label>
        <input type="file" accept="image/*" onchange="handlePhotoUpload(event)" 
               class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4
                      file:rounded-full file:border-0 file:text-sm file:font-semibold
                      file:bg-blue-500 file:text-white hover:file:bg-blue-600"
               id="photoInput">
        <div id="photoPreview" class="mt-4 hidden">
          <img id="previewImage" class="max-h-64 rounded-lg shadow">
        </div>
        <div id="uploadStatus" class="mt-2 text-sm text-gray-600 flex items-center">
          <span id="statusText"></span>
          <span id="statusLoader" class="hidden ml-2">
            <div class="loader"></div>
          </span>
        </div>
      </div>
    </div>
    
    <!-- История тестов -->
    <div class="bg-white rounded-lg shadow-md p-6">
      <h2 class="text-xl font-semibold text-gray-700 mb-4">История выполнения</h2>
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead>
            <tr class="bg-gray-100 text-gray-600 text-sm uppercase">
              <th class="px-4 py-2 text-left">Дата</th>
              <th class="px-4 py-2 text-left">Сервис</th>
              <th class="px-4 py-2 text-left">Пример</th>
              <th class="px-4 py-2 text-left">Статус</th>
              <th class="px-4 py-2 text-left">Фото</th>
            </tr>
          </thead>
          <tbody id="historyTable" class="text-sm"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // Настройки Telegram
    const TELEGRAM_BOT_TOKEN = '7861714766:AAFjAVPfDqsTalEu5BeUiUgguKXhQewCnhY'; // ЗАМЕНИТЬ НА СВОЙ!
    const TELEGRAM_CHAT_ID = '-1002668654626';     // ЗАМЕНИТЬ НА СВОЙ!

    // Примеры тестов
    const testExamples = [
      "Куллер в клиентской зоне",
      "Стол в клиентской зоне",
      "Диван в инженерной зоне",
      "Эконом-панель в клиентской зоне номер 1",
      "Эконом-панель номер 2",
      "Стол приёмщика в инженерной зоне номер 1",
      "Стол приёмщика в инженерной зоне номер 2",
      "Стол инженера номер 1",
      "Стол инженера номер 2",
      "Шкаф с запчастями",
      "Панорама с ведущим видео наблюдением",
      "Рекламный стенд",
      "Селфи сотрудника",
      "Сервис в дневное время (входная группа)",
      "Сервис в ночное время (входная группа)",
      "Демонстрация гидрогелевой защиты"
    ];

    // Инициализация данных
    if (!localStorage.getItem('photoTests')) {
      localStorage.setItem('photoTests', JSON.stringify([]));
    }

    function getCurrentTest() {
      const now = new Date();
      const targetHour = 5;
      if (now.getHours() < targetHour) now.setDate(now.getDate() - 1);
      const today = now.toISOString().split('T')[0];
      let tests = JSON.parse(localStorage.getItem('photoTests'));
      let currentTest = tests.find(t => t.date === today);
      
      if (!currentTest) {
        currentTest = {
          date: today,
          example: testExamples[Math.floor(Math.random() * testExamples.length)],
          service: null,
          status: 'pending',
          photo: null,
          telegramSent: false,
          missedNotificationSent: false
        };
        tests.push(currentTest);
        localStorage.setItem('photoTests', JSON.stringify(tests));
      }
      
      return currentTest;
    }

    function isDeadlineMissed(date = null) {
      const now = new Date();
      const deadline = new Date();
      deadline.setHours(21, 0, 0, 0);
      
      if (date) {
        const testDate = new Date(date);
        const compareDate = new Date(testDate);
        compareDate.setHours(21, 0, 0, 0);
        return now > compareDate;
      }
      
      return now > deadline;
    }

    function dataURLtoBlob(dataURL) {
      const arr = dataURL.split(',');
      const mime = arr[0].match(/:(.*?);/)[1];
      const bstr = atob(arr[1]);
      let n = bstr.length;
      const u8arr = new Uint8Array(n);
      while (n--) u8arr[n] = bstr.charCodeAt(n);
      return new Blob([u8arr], {type: mime});
    }

    async function sendToTelegram(photoData) {
      try {
        if (!TELEGRAM_BOT_TOKEN || !TELEGRAM_CHAT_ID || 
            TELEGRAM_BOT_TOKEN.includes('YOUR') || TELEGRAM_CHAT_ID.includes('YOUR')) {
          showNotification('Настройте Telegram API в коде', 'warning');
          console.error('Telegram bot token или chat_id не установлены.');
          return false;
        }
        
        const blob = dataURLtoBlob(photoData);
        const fileName = `photo-${new Date().toISOString()}.jpg`;
        const file = new File([blob], fileName, { type: 'image/jpeg' });
        const formData = new FormData();
        const currentTest = getCurrentTest();
        
        formData.append('chat_id', TELEGRAM_CHAT_ID);
        formData.append('photo', file);
        formData.append('caption', `Фото-тест от ${new Date().toLocaleDateString()}\nСервис: ${currentTest.service}\nОбъект: ${currentTest.example}`);
        
        const response = await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendPhoto`, {
          method: 'POST',
          body: formData
        });
        
        const result = await response.json();
        
        if (result.ok) {
          showNotification('Фото успешно отправлено в Telegram!', 'success');
          updateTestStatus('completed');
          return true;
        } else {
          throw new Error(`Telegram API error: ${result.description}`);
        }
      } catch (error) {
        console.error('Ошибка отправки в Telegram:', error);
        showNotification('Ошибка отправки фото в Telegram', 'error');
        return false;
      }
    }

    function updateTestStatus(newStatus) {
      const tests = JSON.parse(localStorage.getItem('photoTests'));
      const currentTest = getCurrentTest();
      const index = tests.findIndex(t => t.date === currentTest.date);
      
      if (index !== -1) {
        tests[index].status = newStatus;
        tests[index].telegramSent = (newStatus === 'completed');
        localStorage.setItem('photoTests', JSON.stringify(tests));
      }
    }

    function showNotification(message, type = 'info') {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.className = 'notification';
      
      switch(type) {
        case 'success': notification.classList.add('bg-green-500'); break;
        case 'error': notification.classList.add('bg-red-500'); break;
        case 'warning': notification.classList.add('bg-yellow-500'); break;
        default: notification.classList.add('bg-blue-500');
      }
      
      notification.classList.add('show');
      
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => { notification.textContent = ''; }, 300);
      }, 5000);
    }

    // Переменная для хранения callback функции подтверждения
    let confirmationCallback = null;

    // Функции для управления модальным окном
    function showConfirmation(callback) {
      confirmationCallback = callback;
      document.getElementById('confirmationModal').classList.remove('hidden');
    }

    function hideConfirmation(confirmed) {
      document.getElementById('confirmationModal').classList.add('hidden');
      
      if (confirmed && confirmationCallback) {
        confirmationCallback();
      }
      
      confirmationCallback = null;
    }

    function checkMissedTests() {
      const now = new Date();
      const deadline = new Date();
      deadline.setHours(21, 0, 0, 0);
      
      const today = now.toISOString().split('T')[0];
      const tests = JSON.parse(localStorage.getItem('photoTests')) || [];
      
      const missedTests = tests.filter(t => t.date === today && t.status !== 'completed' && !t.missedNotificationSent);
      
      if (missedTests.length > 0) {
        missedTests.forEach(test => {
          const message = `⚠️ Фотомониторинг не пройден\nДата: ${test.date}\nСервис: ${test.service || 'Не указан'}`;
          
          fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              chat_id: TELEGRAM_CHAT_ID,
              text: message
            })
          })
          .then(() => {
            test.missedNotificationSent = true;
          })
          .catch(error => {
            console.error('Ошибка отправки уведомления:', error);
          });
        });
        localStorage.setItem('photoTests', JSON.stringify(tests));
      }
      
      // Обновляем статусы устаревших тестов
      tests.forEach(test => {
        if (test.status !== 'completed' && isDeadlineMissed(test.date)) {
          test.status = 'missed';
        }
      });
      localStorage.setItem('photoTests', JSON.stringify(tests));
    }

    function confirmService() {
      const select = document.getElementById('serviceSelect');
      const selectedService = select.value;
      
      if (!selectedService) {
        showNotification('Пожалуйста, выберите сервис', 'warning');
        return;
      }
      
      const tests = JSON.parse(localStorage.getItem('photoTests'));
      const currentTest = getCurrentTest();
      
      // Проверяем дедлайн перед установкой статуса в "в процессе"
      const now = new Date();
      const deadline = new Date();
      deadline.setHours(21, 0, 0, 0);
      
      currentTest.service = selectedService;
      currentTest.status = now > deadline ? 'missed' : 'in_progress';
      
      const index = tests.findIndex(t => t.date === currentTest.date);
      
      if (index !== -1) {
        tests[index] = currentTest;
      } else {
        tests.push(currentTest);
      }
      
      localStorage.setItem('photoTests', JSON.stringify(tests));
      document.getElementById('serviceModal').classList.add('hidden');
      init();
    }

    function init() {
      // Получаем текущий тест
      const currentTest = getCurrentTest();
      
      // Если сервис не выбран, показываем модальное окно
      if (!currentTest.service) {
        document.getElementById('serviceModal').classList.remove('hidden');
        return;
      }
      
      // Обновляем элементы интерфейса
      document.getElementById('testExample').textContent = currentTest.example;
      document.getElementById('testService').textContent = currentTest.service;
      
      // Обновляем статус
      const statusBadge = document.getElementById('statusBadge');
      
      if (currentTest.status === 'completed') {
        statusBadge.className = 'inline-flex items-center px-3 py-1 rounded-full text-white font-medium bg-green-500';
        statusBadge.textContent = 'Выполнено';
      } else if (currentTest.status === 'in_progress') {
        statusBadge.className = 'inline-flex items-center px-3 py-1 rounded-full text-white font-medium bg-yellow-500';
        statusBadge.textContent = 'В процессе';
      } else if (currentTest.status === 'missed') {
        statusBadge.className = 'inline-flex items-center px-3 py-1 rounded-full text-white font-medium bg-red-500';
        statusBadge.textContent = 'Не выполнено';
      } else {
        statusBadge.className = 'inline-flex items-center px-3 py-1 rounded-full text-white font-medium bg-blue-500';
        statusBadge.textContent = 'Назначен';
      }
      
      // Обновляем предварительный просмотр фото
      const previewImage = document.getElementById('previewImage');
      const photoPreview = document.getElementById('photoPreview');
      if (currentTest.photo) {
        previewImage.src = currentTest.photo;
        photoPreview.classList.remove('hidden');
        
        if (!currentTest.telegramSent) {
          document.getElementById('statusText').textContent = 'Отправка в Telegram...';
          document.getElementById('statusLoader').classList.remove('hidden');
          
          // Показываем модальное окно перед отправкой
          showConfirmation(() => {
            sendToTelegram(currentTest.photo).then(() => {
              document.getElementById('statusText').textContent = 'Успешно!';
              document.getElementById('statusLoader').classList.add('hidden');
            });
          });
        } else {
          document.getElementById('statusText').textContent = 'Успешно!';
          document.getElementById('statusLoader').classList.add('hidden');
        }
      }
      
      // Обновляем историю тестов
      const historyTable = document.getElementById('historyTable');
      historyTable.innerHTML = '';
      
      JSON.parse(localStorage.getItem('photoTests')).slice(-7).forEach(test => {
        const row = document.createElement('tr');
        row.className = 'border-b border-gray-200';
        row.innerHTML = `
          <td class="px-4 py-3">${test.date}</td>
          <td class="px-4 py-3">${test.service || '-'}</td>
          <td class="px-4 py-3">${test.example}</td>
          <td class="px-4 py-3">
            <span class="px-2 py-1 rounded text-white text-xs ${
              test.status === 'completed' ? 'bg-green-500' : 
              test.status === 'in_progress' ? 'bg-yellow-500' : 
              test.status === 'missed' ? 'bg-red-500' : 'bg-blue-500'
            }">
              ${test.status === 'completed' ? 'Выполнено' : 
               test.status === 'in_progress' ? 'В процессе' : 
               test.status === 'missed' ? 'Не выполнено' : 'Назначен'}
            </span>
          </td>
          <td class="px-4 py-3">
            ${test.photo ? 
              (test.telegramSent ? 
                `<img src="${test.photo}" class="h-16 rounded">` : 
                `<div class="flex items-center">
                  <img src="${test.photo}" class="h-16 rounded mr-2">
                  <span class="text-xs bg-blue-500 text-white px-2 py-1 rounded">Отправка...</span>
                </div>`) : 
              (test.status === 'missed' ? 'Нет фото' : '-')}
          </td>
        `;
        historyTable.appendChild(row);
      });
      
      // Проверяем пропущенные тесты
      checkMissedTests();
      
      // Добавляем логику для отключения кнопки выбора файла
      const photoInput = document.getElementById('photoInput');
      if (photoInput) {
        // Если статус "Не выполнено" или дедлайн прошёл
        if (currentTest.status === 'missed' || isDeadlineMissed(currentTest.date)) {
          photoInput.disabled = true;
          photoInput.classList.add('cursor-not-allowed', 'opacity-50');
        } else if (currentTest.status === 'in_progress' || currentTest.status === 'pending') {
          photoInput.disabled = false;
          photoInput.classList.remove('cursor-not-allowed', 'opacity-50');
        } else {
          photoInput.disabled = false;
          photoInput.classList.remove('cursor-not-allowed', 'opacity-50');
        }
      }
    }

    function handlePhotoUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        const tests = JSON.parse(localStorage.getItem('photoTests'));
        const today = new Date().toISOString().split('T')[0];
        const currentTest = tests.find(t => t.date === today);
        
        if (currentTest && !isDeadlineMissed(today)) {
          currentTest.status = 'completed';
          currentTest.photo = e.target.result;
          currentTest.telegramSent = false;
          localStorage.setItem('photoTests', JSON.stringify(tests));
          init();
        } else {
          // Обновляем статус на "Не выполнено" если уже после 21:00
          if (currentTest && currentTest.status !== 'missed') {
            currentTest.status = 'missed';
            localStorage.setItem('photoTests', JSON.stringify(tests));
          }
          
          showNotification('Время для загрузки фото истекло', 'error');
          init();
        }
      };
      
      reader.readAsDataURL(file);
    }

    function updateServiceSelection() {
      const serviceSelect = document.getElementById('serviceSelect');
      const confirmBtn = document.getElementById('confirmServiceBtn');
      
      if (serviceSelect && confirmBtn) {
        confirmBtn.disabled = !serviceSelect.value;
      }
    }

    // Инициализация
    document.addEventListener('DOMContentLoaded', () => {
      // Обработчик изменения выбора сервиса
      const serviceSelect = document.getElementById('serviceSelect');
      const confirmBtn = document.getElementById('confirmServiceBtn');
      
      if (serviceSelect && confirmBtn) {
        serviceSelect.addEventListener('change', () => {
          updateServiceSelection();
        });
        updateServiceSelection(); // Инициализируем начальное состояние кнопки
      }
      
      // Инициализация при загрузке страницы
      window.addEventListener('load', () => {
        checkMissedTests();
        init();
      });
    });
  </script>
</body>
</html>